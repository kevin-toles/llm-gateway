# =============================================================================
# LLM Gateway - ServiceAccount Template Unit Tests
# =============================================================================
# Tests for deploy/helm/llm-gateway/templates/serviceaccount.yaml
# Run with: helm unittest deploy/helm/llm-gateway
# =============================================================================

suite: serviceaccount template tests
templates:
  - templates/serviceaccount.yaml

tests:
  # =========================================================================
  # Conditional Creation Tests
  # =========================================================================
  - it: should create ServiceAccount by default
    asserts:
      - isKind:
          of: ServiceAccount

  - it: should NOT create ServiceAccount when disabled
    set:
      serviceAccount:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  # =========================================================================
  # Basic Resource Tests
  # =========================================================================
  - it: should have correct API version
    asserts:
      - isAPIVersion:
          of: v1

  - it: should use fullname for metadata name
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-llm-gateway

  - it: should use custom name when specified
    set:
      serviceAccount:
        create: true
        name: custom-service-account
    asserts:
      - equal:
          path: metadata.name
          value: custom-service-account

  # =========================================================================
  # Labels Tests
  # =========================================================================
  - it: should have standard Kubernetes labels
    asserts:
      - isNotEmpty:
          path: metadata.labels["helm.sh/chart"]
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: llm-gateway

  # =========================================================================
  # Annotations Tests (Cloud Provider Workload Identity)
  # =========================================================================
  - it: should apply AWS IRSA annotation when provided
    set:
      serviceAccount:
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/llm-gateway-role
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/llm-gateway-role

  - it: should apply GCP Workload Identity annotation when provided
    set:
      serviceAccount:
        annotations:
          iam.gke.io/gcp-service-account: llm-gateway@project.iam.gserviceaccount.com
    asserts:
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: llm-gateway@project.iam.gserviceaccount.com

  - it: should apply Azure Workload Identity annotation when provided
    set:
      serviceAccount:
        annotations:
          azure.workload.identity/client-id: 00000000-0000-0000-0000-000000000000
    asserts:
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: 00000000-0000-0000-0000-000000000000
