# =============================================================================
# LLM Gateway - Service Template Unit Tests
# =============================================================================
# Tests for deploy/helm/llm-gateway/templates/service.yaml
# Run with: helm unittest deploy/helm/llm-gateway
# =============================================================================

suite: service template tests
templates:
  - templates/service.yaml

tests:
  # =========================================================================
  # Basic Resource Tests
  # =========================================================================
  - it: should be a Service
    asserts:
      - isKind:
          of: Service

  - it: should have correct API version
    asserts:
      - isAPIVersion:
          of: v1

  - it: should use fullname for metadata name
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-llm-gateway

  # =========================================================================
  # Service Type Tests
  # =========================================================================
  - it: should default to ClusterIP type
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should use NodePort when specified
    set:
      service:
        type: NodePort
        port: 8080
        nodePort: 30080
    asserts:
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].nodePort
          value: 30080

  - it: should use LoadBalancer when specified
    set:
      service:
        type: LoadBalancer
        port: 8080
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  # =========================================================================
  # Port Configuration Tests
  # =========================================================================
  - it: should have http port configured
    asserts:
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[0].port
          value: 8080
      - equal:
          path: spec.ports[0].targetPort
          value: http
      - equal:
          path: spec.ports[0].protocol
          value: TCP

  - it: should use custom port when specified
    set:
      service:
        port: 9090
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 9090

  # =========================================================================
  # Selector Tests
  # =========================================================================
  - it: should have correct selector labels
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: llm-gateway
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  # =========================================================================
  # Annotations Tests
  # =========================================================================
  - it: should apply service annotations when provided
    set:
      service:
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: nlb
          external-dns.alpha.kubernetes.io/hostname: llm-gateway.example.com
    asserts:
      - equal:
          path: metadata.annotations["service.beta.kubernetes.io/aws-load-balancer-type"]
          value: nlb
