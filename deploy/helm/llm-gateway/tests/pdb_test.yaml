# =============================================================================
# LLM Gateway - PDB Template Unit Tests
# =============================================================================
# Tests for deploy/helm/llm-gateway/templates/pdb.yaml
# Run with: helm unittest deploy/helm/llm-gateway
# =============================================================================

suite: pdb template tests
templates:
  - templates/pdb.yaml

tests:
  # =========================================================================
  # Conditional Creation Tests
  # =========================================================================
  - it: should create PDB when enabled
    set:
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
    asserts:
      - isKind:
          of: PodDisruptionBudget

  - it: should NOT create PDB when disabled
    set:
      podDisruptionBudget:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # =========================================================================
  # Basic Resource Tests
  # =========================================================================
  - it: should have correct API version
    set:
      podDisruptionBudget:
        enabled: true
    asserts:
      - isAPIVersion:
          of: policy/v1

  - it: should use fullname for metadata name
    set:
      podDisruptionBudget:
        enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-llm-gateway

  # =========================================================================
  # Selector Tests
  # =========================================================================
  - it: should have correct selector labels
    set:
      podDisruptionBudget:
        enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: llm-gateway
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  # =========================================================================
  # Availability Configuration Tests
  # =========================================================================
  - it: should use minAvailable when specified
    set:
      podDisruptionBudget:
        enabled: true
        minAvailable: 2
    asserts:
      - equal:
          path: spec.minAvailable
          value: 2
      - isNull:
          path: spec.maxUnavailable

  - it: should use maxUnavailable when specified (and minAvailable not set)
    set:
      podDisruptionBudget:
        enabled: true
        minAvailable: null
        maxUnavailable: 1
    asserts:
      - equal:
          path: spec.maxUnavailable
          value: 1

  - it: should default to minAvailable 1 when neither specified
    set:
      podDisruptionBudget:
        enabled: true
        minAvailable: null
        maxUnavailable: null
    asserts:
      - equal:
          path: spec.minAvailable
          value: 1

  - it: should support percentage for minAvailable
    set:
      podDisruptionBudget:
        enabled: true
        minAvailable: "50%"
    asserts:
      - equal:
          path: spec.minAvailable
          value: "50%"
