# =============================================================================
# LLM Gateway - Continuous Deployment (Production)
# =============================================================================
# Triggers: release published, workflow_dispatch (manual)
# Deploys using Helm to production Kubernetes cluster
# Requires approval via GitHub environment protection rules
# =============================================================================

name: CD - Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version/tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Perform dry-run only (no actual deployment)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KUBE_NAMESPACE: llm-services
  ENVIRONMENT: production
  HELM_RELEASE_NAME: llm-gateway

# Prevent concurrent deployments to production
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Validate Job - Pre-deployment Validation
  # ===========================================================================
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      image_exists: ${{ steps.check-image.outputs.exists }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ inputs.version }}"
          fi

          # Validate semver format
          if ! [[ "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "ERROR: Version '$VERSION' is not valid semver"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check image exists
        id: check-image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          echo "Checking for image: $IMAGE"

          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Image not found"
            exit 1
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Validate Helm chart
        run: |
          echo "Validating Helm chart..."
          helm lint deploy/helm/llm-gateway \
            -f deploy/helm/llm-gateway/values-prod.yaml

          echo "Performing template dry-run..."
          helm template ${{ env.HELM_RELEASE_NAME }} deploy/helm/llm-gateway \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            -f deploy/helm/llm-gateway/values-prod.yaml \
            --set image.tag=${{ steps.version.outputs.version }} \
            > /dev/null

          echo "‚úÖ Helm chart validation passed"

  # ===========================================================================
  # Deploy Job - Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://llm-gateway.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Check current deployment
        id: current
        continue-on-error: true
        run: |
          CURRENT=$(helm get values ${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            -o json 2>/dev/null | jq -r '.image.tag // "none"')
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current deployed version: $CURRENT"

      - name: Helm diff (preview changes)
        run: |
          # Install helm-diff plugin
          helm plugin install https://github.com/databus23/helm-diff || true

          echo "=== Changes to be applied ==="
          helm diff upgrade ${{ env.HELM_RELEASE_NAME }} deploy/helm/llm-gateway \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            -f deploy/helm/llm-gateway/values-prod.yaml \
            --set image.tag=${{ needs.validate.outputs.version }} \
            --set secrets.anthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }} \
            --set secrets.openaiApiKey=${{ secrets.OPENAI_API_KEY }} \
            --allow-unreleased || true

      - name: Deploy with Helm (dry-run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "=== DRY RUN MODE ==="
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} deploy/helm/llm-gateway \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --create-namespace \
            -f deploy/helm/llm-gateway/values-prod.yaml \
            --set image.tag=${{ needs.validate.outputs.version }} \
            --set secrets.anthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }} \
            --set secrets.openaiApiKey=${{ secrets.OPENAI_API_KEY }} \
            --dry-run

          echo "‚úÖ Dry run completed - no changes applied"

      - name: Deploy with Helm
        if: ${{ inputs.dry_run != true }}
        run: |
          echo "Deploying version ${{ needs.validate.outputs.version }} to production..."

          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} deploy/helm/llm-gateway \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --create-namespace \
            -f deploy/helm/llm-gateway/values-prod.yaml \
            --set image.tag=${{ needs.validate.outputs.version }} \
            --set secrets.anthropicApiKey=${{ secrets.ANTHROPIC_API_KEY }} \
            --set secrets.openaiApiKey=${{ secrets.OPENAI_API_KEY }} \
            --wait \
            --timeout 10m \
            --atomic

          echo "‚úÖ Helm deployment completed"

      - name: Wait for rollout
        if: ${{ inputs.dry_run != true }}
        run: |
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            --timeout=300s

      - name: Get deployment status
        if: always() && inputs.dry_run != true
        run: |
          echo "=== Helm Release Status ==="
          helm status ${{ env.HELM_RELEASE_NAME }} -n ${{ env.KUBE_NAMESPACE }}

          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -l app.kubernetes.io/name=llm-gateway -o wide

          echo ""
          echo "=== Deployment History ==="
          helm history ${{ env.HELM_RELEASE_NAME }} -n ${{ env.KUBE_NAMESPACE }} --max 5

  # ===========================================================================
  # Verify Job - Post-deployment Verification
  # ===========================================================================
  verify:
    name: Verify Deployment
    needs: [validate, deploy]
    runs-on: ubuntu-latest
    if: ${{ inputs.dry_run != true }}
    environment: production

    steps:
      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Verify deployment version
        run: |
          echo "Verifying deployed version..."
          DEPLOYED_IMAGE=$(kubectl get deployment ${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            -o jsonpath='{.spec.template.spec.containers[0].image}')

          echo "Deployed image: $DEPLOYED_IMAGE"

          if [[ "$DEPLOYED_IMAGE" != *"${{ needs.validate.outputs.version }}"* ]]; then
            echo "ERROR: Deployed image does not match expected version"
            exit 1
          fi

          echo "‚úÖ Version verified"

      - name: Run health checks
        run: |
          echo "Running production health checks..."

          # Get a running pod
          POD=$(kubectl get pods -n ${{ env.KUBE_NAMESPACE }} \
            -l app.kubernetes.io/name=llm-gateway \
            -o jsonpath='{.items[0].metadata.name}' \
            --field-selector=status.phase=Running)

          if [ -z "$POD" ]; then
            echo "ERROR: No running pods found"
            exit 1
          fi

          echo "Testing pod: $POD"

          # Health endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/health
          echo "‚úÖ Health check passed"

          # Ready endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/ready
          echo "‚úÖ Readiness check passed"

          # Live endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/live
          echo "‚úÖ Liveness check passed"

      - name: Verify all pods healthy
        run: |
          echo "Checking pod health..."

          READY_PODS=$(kubectl get deployment ${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            -o jsonpath='{.status.readyReplicas}')

          DESIRED_PODS=$(kubectl get deployment ${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            -o jsonpath='{.spec.replicas}')

          echo "Ready: $READY_PODS / $DESIRED_PODS"

          if [ "$READY_PODS" != "$DESIRED_PODS" ]; then
            echo "ERROR: Not all pods are ready"
            kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -l app.kubernetes.io/name=llm-gateway
            exit 1
          fi

          echo "‚úÖ All pods healthy"

  # ===========================================================================
  # Rollback Job - Emergency Rollback (manual trigger only)
  # ===========================================================================
  rollback:
    name: Rollback (if needed)
    needs: [deploy, verify]
    runs-on: ubuntu-latest
    if: ${{ failure() && inputs.dry_run != true }}
    environment: production

    steps:
      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Rollback to previous version
        run: |
          echo "‚ö†Ô∏è Rolling back to previous version..."
          helm rollback ${{ env.HELM_RELEASE_NAME }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            --wait \
            --timeout 5m

          echo "‚úÖ Rollback completed"

      - name: Get rollback status
        run: |
          echo "=== Post-rollback Status ==="
          helm status ${{ env.HELM_RELEASE_NAME }} -n ${{ env.KUBE_NAMESPACE }}

          echo ""
          echo "=== Deployment History ==="
          helm history ${{ env.HELM_RELEASE_NAME }} -n ${{ env.KUBE_NAMESPACE }} --max 5

  # ===========================================================================
  # Notify Job - Send Notifications
  # ===========================================================================
  notify:
    name: Notify
    needs: [validate, deploy, verify]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification (success)
        if: ${{ needs.deploy.result == 'success' && needs.verify.result == 'success' }}
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "üöÄ *LLM Gateway* ${{ needs.validate.outputs.version }} deployed to *PRODUCTION*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üöÄ *LLM Gateway* deployed to *PRODUCTION*\n‚Ä¢ Version: `${{ needs.validate.outputs.version }}`\n‚Ä¢ Commit: `${{ github.sha }}`\n‚Ä¢ Actor: `${{ github.actor }}`\n‚Ä¢ Status: All checks passed ‚úì\n‚Ä¢ <https://llm-gateway.example.com|View Application>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (failure)
        if: ${{ needs.deploy.result == 'failure' || needs.verify.result == 'failure' }}
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "üî¥ *LLM Gateway* PRODUCTION deployment FAILED",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üî¥ *LLM Gateway* PRODUCTION deployment FAILED\n‚Ä¢ Version: `${{ needs.validate.outputs.version }}`\n‚Ä¢ Deploy: ${{ needs.deploy.result }}\n‚Ä¢ Verify: ${{ needs.verify.result }}\n‚Ä¢ Automatic rollback initiated\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (dry-run)
        if: ${{ inputs.dry_run == true }}
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "üîç *LLM Gateway* PRODUCTION dry-run completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üîç *LLM Gateway* PRODUCTION dry-run completed\n‚Ä¢ Version: `${{ needs.validate.outputs.version }}`\n‚Ä¢ No changes applied\n‚Ä¢ Review the workflow output for changes preview"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub deployment status
        if: ${{ needs.deploy.result == 'success' && needs.verify.result == 'success' && inputs.dry_run != true }}
        uses: bobheadxi/deployments@v1
        continue-on-error: true
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: success
          env: production
          deployment_id: ${{ github.run_id }}
