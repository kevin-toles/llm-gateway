# =============================================================================
# LLM Gateway - Continuous Deployment (Development)
# =============================================================================
# Triggers: push to develop branch, workflow_dispatch
# Deploys using Kustomize to development Kubernetes cluster
# =============================================================================

name: CD - Development

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest develop build)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KUBE_NAMESPACE: llm-services-dev
  ENVIRONMENT: development

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Deploy Job - Deploy to Development
  # ===========================================================================
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Determine image tag
        id: image-tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=sha-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Kustomize image
        working-directory: deploy/kubernetes/overlays/dev
        run: |
          kustomize edit set image llm-gateway=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}

      - name: Validate manifests
        run: |
          kustomize build deploy/kubernetes/overlays/dev | kubectl apply --dry-run=client -f -

      - name: Deploy with Kustomize
        run: |
          echo "Deploying to ${{ env.ENVIRONMENT }}..."
          kustomize build deploy/kubernetes/overlays/dev | kubectl apply -f -

      - name: Wait for rollout
        run: |
          echo "Waiting for deployment rollout..."
          kubectl rollout status deployment/llm-gateway \
            -n ${{ env.KUBE_NAMESPACE }} \
            --timeout=300s

      - name: Get deployment status
        if: always()
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment llm-gateway -n ${{ env.KUBE_NAMESPACE }} -o wide

          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -l app.kubernetes.io/name=llm-gateway

          echo ""
          echo "=== Recent Events ==="
          kubectl get events -n ${{ env.KUBE_NAMESPACE }} --sort-by='.lastTimestamp' | tail -10

  # ===========================================================================
  # Smoke Test Job - Verify Deployment
  # ===========================================================================
  smoke-test:
    name: Smoke Test
    needs: deploy
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Run health check
        run: |
          echo "Running health check..."
          POD=$(kubectl get pods -n ${{ env.KUBE_NAMESPACE }} \
            -l app.kubernetes.io/name=llm-gateway \
            -o jsonpath='{.items[0].metadata.name}' \
            --field-selector=status.phase=Running)

          if [ -z "$POD" ]; then
            echo "ERROR: No running pods found"
            exit 1
          fi

          echo "Testing pod: $POD"

          # Health endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/health || exit 1

          echo "✅ Health check passed"

      - name: Run readiness check
        run: |
          POD=$(kubectl get pods -n ${{ env.KUBE_NAMESPACE }} \
            -l app.kubernetes.io/name=llm-gateway \
            -o jsonpath='{.items[0].metadata.name}' \
            --field-selector=status.phase=Running)

          # Readiness endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/ready || exit 1

          echo "✅ Readiness check passed"

      - name: Verify API response
        run: |
          POD=$(kubectl get pods -n ${{ env.KUBE_NAMESPACE }} \
            -l app.kubernetes.io/name=llm-gateway \
            -o jsonpath='{.items[0].metadata.name}' \
            --field-selector=status.phase=Running)

          # API version/info endpoint
          kubectl exec -n ${{ env.KUBE_NAMESPACE }} $POD -- \
            curl -sf http://localhost:8080/api/v1/info || exit 1

          echo "✅ API response check passed"

  # ===========================================================================
  # Notify Job - Send Notifications
  # ===========================================================================
  notify:
    name: Notify
    needs: [deploy, smoke-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Slack notification (success)
        if: ${{ needs.deploy.result == 'success' && needs.smoke-test.result == 'success' }}
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "✅ *LLM Gateway* deployed to *development*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *LLM Gateway* deployed to *development*\n• Commit: `${{ github.sha }}`\n• Branch: `${{ github.ref_name }}`\n• Actor: `${{ github.actor }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Slack notification (failure)
        if: ${{ needs.deploy.result == 'failure' || needs.smoke-test.result == 'failure' }}
        uses: slackapi/slack-github-action@v1
        continue-on-error: true
        with:
          payload: |
            {
              "text": "❌ *LLM Gateway* deployment to *development* FAILED",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *LLM Gateway* deployment to *development* FAILED\n• Commit: `${{ github.sha }}`\n• Branch: `${{ github.ref_name }}`\n• Actor: `${{ github.actor }}`\n• <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
